"""\n區間震盪策略信號生成器\n"""\n\nimport pandas as pd\nimport numpy as np\nfrom models.range_bound_strategy import RangeBoundStrategy\n\n\nclass RangeBoundSignalGenerator:\n    def __init__(\n        self,\n        adx_threshold: float = 25,\n        rsi_oversold: float = 30,\n        rsi_overbought: float = 70,\n        volume_threshold: float = 0.8,\n        use_atr_stops: bool = True,\n        atr_multiplier: float = 2.0,\n        fixed_stop_pct: float = 0.02,\n        target_rr: float = 2.0\n    ):\n        self.strategy = RangeBoundStrategy(\n            adx_threshold=adx_threshold,\n            rsi_oversold=rsi_oversold,\n            rsi_overbought=rsi_overbought,\n            volume_threshold=volume_threshold,\n            use_atr_stops=use_atr_stops,\n            atr_multiplier=atr_multiplier,\n            fixed_stop_pct=fixed_stop_pct,\n            target_rr=target_rr\n        )\n    \n    def generate_signals(self, df: pd.DataFrame) -> pd.DataFrame:\n        """生成交易信號"""\n        df = df.copy()\n        df = self.strategy.add_indicators(df)\n        \n        # 初始化信號欄位\n        df['signal'] = 0\n        df['stop_loss'] = np.nan\n        df['take_profit'] = np.nan\n        \n        for i in range(50, len(df)):\n            row = df.iloc[i]\n            \n            # 檢查盤整\n            if pd.isna(row['adx']) or row['adx'] >= self.strategy.adx_threshold:\n                continue\n            \n            if pd.isna(row['bb_width']) or row['bb_width'] < 0.01:\n                continue\n            \n            current_price = row['close']\n            atr = row['atr']\n            volume_contracted = row['volume'] < (row['volume_ma'] * self.strategy.volume_threshold)\n            \n            # 做多信號\n            if (row['close'] <= row['bb_lower'] and \n                row['rsi'] < self.strategy.rsi_oversold and \n                volume_contracted):\n                \n                if self.strategy.use_atr_stops:\n                    stop_loss = current_price - (atr * self.strategy.atr_multiplier)\n                else:\n                    stop_loss = current_price * (1 - self.strategy.fixed_stop_pct)\n                \n                take_profit = row['bb_mid']\n                risk = current_price - stop_loss\n                reward = take_profit - current_price\n                if reward / risk < 1.0:\n                    take_profit = current_price + (risk * self.strategy.target_rr)\n                \n                df.loc[df.index[i], 'signal'] = 1\n                df.loc[df.index[i], 'stop_loss'] = stop_loss\n                df.loc[df.index[i], 'take_profit'] = take_profit\n            \n            # 做空信號\n            elif (row['close'] >= row['bb_upper'] and \n                  row['rsi'] > self.strategy.rsi_overbought and \n                  volume_contracted):\n                \n                if self.strategy.use_atr_stops:\n                    stop_loss = current_price + (atr * self.strategy.atr_multiplier)\n                else:\n                    stop_loss = current_price * (1 + self.strategy.fixed_stop_pct)\n                \n                take_profit = row['bb_mid']\n                risk = stop_loss - current_price\n                reward = current_price - take_profit\n                if reward / risk < 1.0:\n                    take_profit = current_price - (risk * self.strategy.target_rr)\n                \n                df.loc[df.index[i], 'signal'] = -1\n                df.loc[df.index[i], 'stop_loss'] = stop_loss\n                df.loc[df.index[i], 'take_profit'] = take_profit\n        \n        return df\n